# План интеграции Frontend и Backend для Learnify

## Обзор текущего состояния

### Backend (FastAPI)
- **Порт**: 3001 (внешний) / 3000 (внутри контейнера)
- **Базовый URL**: `http://localhost:3001/api` (для разработки)
- **API Prefix**: `/api`
- **База данных**: PostgreSQL
- **CORS**: Настроен для `http://localhost:3000` и `http://frontend:80`

### Frontend (Vue 3 + TypeScript)
- **Порт**: 3000 (dev) / 80 (production)
- **Текущее состояние**: Использует моки (`mockData.ts`)
- **State Management**: Pinia
- **HTTP клиент**: Не настроен (нужно добавить)

---

## Пошаговый план интеграции

### Этап 1: Настройка окружения и зависимостей

#### 1.1. Установка HTTP клиента для фронтенда
- [x] Установить `axios` или использовать встроенный `fetch`
- [x] Создать конфигурацию для API базового URL
- [x] Настроить переменные окружения для разных сред (dev/prod)

#### 1.2. Создание файла конфигурации окружения
- [x] Создать `.env.development` с `VITE_API_URL=http://localhost:3001/api`
- [x] Создать `.env.production` с `VITE_API_URL=http://backend:3000/api` (для Docker)
- [x] Обновить `vite.config.ts` для использования переменных окружения

---

### Этап 2: Создание API клиента

#### 2.1. Создание базового API клиента
- [x] Создать `src/services/api.ts` с базовой конфигурацией axios/fetch
- [x] Настроить interceptors для обработки ошибок
- [x] Добавить обработку токенов авторизации (если будет добавлена позже)

#### 2.2. Создание сервисов для каждого ресурса
- [x] `src/services/coursesService.ts` - работа с курсами
- [x] `src/services/categoriesService.ts` - работа с категориями
- [x] `src/services/lessonsService.ts` - работа с уроками
- [x] `src/services/progressService.ts` - работа с прогрессом
- [x] `src/services/trainingService.ts` - работа с тренировками
- [x] `src/services/achievementsService.ts` - работа с достижениями

---

### Этап 3: Адаптация типов данных

#### 3.1. Синхронизация типов Frontend и Backend
- [ ] Проверить соответствие типов `Course` между frontend и backend
- [ ] Адаптировать тип `Category` (backend возвращает объект, frontend ожидает строку)
- [ ] Проверить соответствие типов `Lesson` и `Block`
- [ ] Создать адаптеры для преобразования данных из API в формат frontend

#### 3.2. Обновление TypeScript типов
- [ ] Обновить `src/types/index.ts` для соответствия API схемам
- [ ] Добавить типы для API ответов
- [ ] Добавить типы для ошибок API

---

### Этап 4: Обновление Stores (Pinia)

#### 4.1. Обновление `coursesStore.ts`
- [ ] Заменить использование моков на вызовы API
- [ ] Добавить методы для загрузки курсов из API
- [ ] Добавить методы для записи на курс через API
- [ ] Добавить обработку состояний загрузки и ошибок
- [ ] Сохранять данные в store после загрузки

#### 4.2. Обновление других stores
- [ ] `achievementsStore.ts` - загрузка достижений из API
- [ ] `userStore.ts` - если есть, обновить для работы с API
- [ ] `cardsStore.ts` - обновить для работы с тренировками через API

---

### Этап 5: Обновление Composables

#### 5.1. Обновление `useCourses.ts`
- [ ] Заменить инициализацию из моков на загрузку из API
- [ ] Добавить async методы для загрузки данных
- [ ] Добавить обработку ошибок

#### 5.2. Создание новых composables (при необходимости)
- [ ] `useApi.ts` - общий composable для работы с API
- [ ] `useProgress.ts` - для работы с прогрессом
- [ ] `useTraining.ts` - для работы с тренировками

---

### Этап 6: Обновление компонентов и views

#### 6.1. Обновление views для загрузки данных из API
- [ ] `CategoriesView.vue` - загрузка категорий из API
- [ ] `CategoryCoursesView.vue` - загрузка курсов по категории
- [ ] `CourseDetailsView.vue` - загрузка деталей курса
- [ ] `LessonView.vue` - загрузка урока с блоками
- [ ] `TrainingView.vue` - загрузка карточек для тренировки
- [ ] `AchievementsView.vue` - загрузка достижений

#### 6.2. Добавление состояний загрузки и ошибок
- [ ] Добавить индикаторы загрузки (loading states)
- [ ] Добавить обработку ошибок с понятными сообщениями
- [ ] Добавить retry механизм для неудачных запросов

---

### Этап 7: Интеграция прогресса и тренировок

#### 7.1. Отправка прогресса на backend
- [ ] При завершении блока отправлять POST `/api/progress/block`
- [ ] При завершении урока отправлять POST `/api/progress/lesson`
- [ ] Обновлять локальный store после успешной отправки

#### 7.2. Интеграция тренировок
- [ ] Загружать карточки через GET `/api/training/cards`
- [ ] Отправлять ответы через POST `/api/training/submit`
- [ ] Обновлять данные spaced repetition на основе ответа

---

### Этап 8: Обработка ошибок и edge cases

#### 8.1. Обработка сетевых ошибок
- [ ] Обработка таймаутов
- [ ] Обработка ошибок соединения
- [ ] Обработка ошибок 404, 500 и других статусов

#### 8.2. Обработка edge cases
- [ ] Пустые списки курсов/уроков
- [ ] Курс без уроков
- [ ] Урок без блоков
- [ ] Офлайн режим (опционально, для будущего)

---

### Этап 9: Оптимизация и производительность

#### 9.1. Кэширование данных
- [ ] Кэшировать список курсов и категорий
- [ ] Кэшировать детали курса
- [ ] Использовать stale-while-revalidate паттерн

#### 9.2. Оптимизация запросов
- [ ] Объединить запросы где возможно
- [ ] Использовать пагинацию для больших списков
- [ ] Ленивая загрузка данных

---

### Этап 10: Тестирование и финальная проверка

#### 10.1. Тестирование интеграции
- [ ] Проверить все API endpoints
- [ ] Проверить обработку ошибок
- [ ] Проверить работу в Docker окружении
- [ ] Проверить работу в dev окружении

#### 10.2. Удаление моков
- [ ] Удалить или закомментировать `mockData.ts`
- [ ] Удалить использование моков из кода
- [ ] Обновить `useCourses.ts` для работы только с API

---

## Детальная структура файлов для создания

### Новые файлы:

```
frontend/src/
├── services/
│   ├── api.ts                    # Базовый API клиент
│   ├── coursesService.ts         # Сервис для курсов
│   ├── categoriesService.ts      # Сервис для категорий
│   ├── lessonsService.ts         # Сервис для уроков
│   ├── progressService.ts        # Сервис для прогресса
│   ├── trainingService.ts        # Сервис для тренировок
│   └── achievementsService.ts    # Сервис для достижений
├── utils/
│   └── apiAdapter.ts            # Адаптеры для преобразования данных
└── .env.development              # Переменные окружения для dev
└── .env.production               # Переменные окружения для prod
```

---

## API Endpoints для интеграции

### Категории
- `GET /api/categories` - получить все категории

### Курсы
- `GET /api/courses` - получить все курсы
- `GET /api/courses?category_id={id}` - получить курсы по категории
- `GET /api/courses/{course_id}` - получить детали курса
- `POST /api/courses/{course_id}/enroll` - записаться на курс
- `GET /api/courses/{course_id}/lessons` - получить уроки курса

### Уроки
- `GET /api/lessons/{lesson_id}` - получить урок с блоками

### Прогресс
- `GET /api/progress` - получить весь прогресс пользователя
- `POST /api/progress/block` - отметить блок как выполненный
- `POST /api/progress/lesson` - отметить урок как завершенный

### Тренировки
- `GET /api/training/cards` - получить карточки для тренировки
- `POST /api/training/submit` - отправить ответ на карточку

### Достижения
- `GET /api/achievements` - получить все достижения
- `POST /api/achievements/{achievement_id}/unlock` - разблокировать достижение

---

## Важные замечания

1. **Несоответствие типов Category**: Backend возвращает объект `CategoryResponse` в поле `category` курса, а frontend ожидает строку. Нужно либо адаптировать frontend, либо добавить адаптер.

2. **Авторизация**: Сейчас используется `DEFAULT_USER_ID = 1`. В будущем нужно будет добавить JWT токены и передавать их в заголовках.

3. **CORS**: Убедиться, что CORS настроен правильно для всех сред.

4. **Обработка ошибок**: Все API вызовы должны иметь обработку ошибок с понятными сообщениями для пользователя.

5. **Состояния загрузки**: Добавить индикаторы загрузки для всех асинхронных операций.

---

## Порядок выполнения (рекомендуемый)

1. **Этап 1** - Настройка окружения (30 мин)
2. **Этап 2** - Создание API клиента (1-2 часа)
3. **Этап 3** - Адаптация типов (30 мин - 1 час)
4. **Этап 4** - Обновление stores (2-3 часа)
5. **Этап 5** - Обновление composables (1 час)
6. **Этап 6** - Обновление компонентов (3-4 часа)
7. **Этап 7** - Интеграция прогресса (1-2 часа)
8. **Этап 8** - Обработка ошибок (1-2 часа)
9. **Этап 9** - Оптимизация (1-2 часа)
10. **Этап 10** - Тестирование (2-3 часа)

**Общее время**: ~15-20 часов работы

---

## Чеклист готовности

- [ ] Все API endpoints протестированы
- [ ] Все ошибки обработаны корректно
- [ ] Данные корректно отображаются во всех views
- [ ] Прогресс сохраняется на backend
- [ ] Тренировки работают с spaced repetition
- [ ] Достижения разблокируются автоматически
- [ ] Приложение работает в Docker
- [ ] Приложение работает в dev режиме
- [ ] Моки удалены или отключены
- [ ] Код соответствует SOLID и KISS принципам

